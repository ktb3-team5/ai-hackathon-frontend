# ============================================
# ai-hackathon-frontend CI/CD Pipeline
# React + Vite + Nginx + EC2
# ============================================
#
# ğŸ“Œ í•„ìˆ˜ GitHub Secrets:
#   - EC2_HOST      : í”„ë¡ íŠ¸ì—”ë“œ EC2 í¼ë¸”ë¦­ IP
#   - EC2_USER      : ubuntu
#   - EC2_SSH_KEY   : .pem íŒŒì¼ ë‚´ìš© ì „ì²´
#   - BACKEND_IP    : ë°±ì—”ë“œ EC2 IP (API í”„ë¡ì‹œìš©)
# ============================================

name: Frontend CI/CD

on:
  push:
    branches: [feat/cicd]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          BACKEND_IP: ${{ secrets.BACKEND_IP }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: BACKEND_IP
          script: |
            set -e

            echo "===== 1. í”„ë¡œì íŠ¸ í´ë¡ /ì—…ë°ì´íŠ¸ ====="
            APP_DIR="/home/ubuntu/ai-hackathon-frontend"
            REPO_URL="https://github.com/ktb3-team5/ai-hackathon-frontend.git"
            BRANCH="feat/cicd"

            if [ ! -d "$APP_DIR" ]; then
              git clone -b $BRANCH $REPO_URL $APP_DIR
            fi

            cd $APP_DIR
            git fetch origin
            git checkout $BRANCH
            git reset --hard origin/$BRANCH

            echo "===== 2. nginx.conf ë°±ì—”ë“œ IP ì„¤ì • ====="
            # BACKEND_IP í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ì‹¤ì œ IPë¡œ êµì²´
            sed -i "s/BACKEND_IP/$BACKEND_IP/g" nginx.conf

            echo "===== 3. Docker ì´ë¯¸ì§€ ë¹Œë“œ ====="
            docker build -t frontend:latest .

            echo "===== 4. ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬ ====="
            docker stop frontend || true
            docker rm frontend || true

            echo "===== 5. ìƒˆ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ====="
            docker run -d \
              --name frontend \
              --restart unless-stopped \
              -p 80:80 \
              frontend:latest

            echo "===== 6. nginx.conf ì›ë³µ (ë‹¤ìŒ ë°°í¬ë¥¼ ìœ„í•´) ====="
            git checkout nginx.conf

            echo "===== 7. ì •ë¦¬ ====="
            docker image prune -af

            echo "===== ë°°í¬ ì™„ë£Œ! ====="
            docker ps | grep frontend